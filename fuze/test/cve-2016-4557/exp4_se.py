#!/usr/bin/python
inspect_vm = 0
test_inject_kasan = 0
from pwn import *
import sys
sys.path.append('/home/ww9210/develop/vminstance')
sys.path.append('/home/ww9210/develop/concolic_execution')
sys.path.append('/home/ww9210/develop/dataflowanalyzer')
import concolicexecutor
import vminstance
import dataflowanalyzer
import subprocess
import re
import random
import angr
import time

def test_4557(gdbport=random.randint(12000,13000)):
    start_time = time.time()
    context.update(arch = 'amd64')
    vm = vminstance.vmInstance(qemu_config_file = \
            '/home/ww9210/develop/kuafffp/poc_qemu_config/cve-2016-4557-inject-nokasan.cfg' \
            , gdb_deamon_port = gdbport\
            , log_filename = 'vm_log_4557_ce.txt'\
            , start_grace_time = 5\
            , two_cpus = True\
            )
    vm.run_gdb_deamon()
    vm.run()
    vm.connect()

    vm.s.put('/home/ww9210/develop/fse2018/test/4557_test/poc_release/exp4/exp4')

    sh = vm.s.shell('/bin/sh')
    sh.sendline('chmod +x ./exp4')

    gdb = dataflowanalyzer.DebuggerGdb(gdbport = gdbport, qemu_gdbport = vm.qemu_config.gdb_port\
            , vmlinux_path = vm.qemu_config.vmlinux_path)

    gdb.connectGdb()
    gdb.loadVmlinux()
    gdb.connectQemu()
    bpline = '/home/ww9210/kernels/linux-4.10-rc8-inject/fs/file.c:707'
    bpline = '/home/ww9210/kernels/linux-4.10-rc8-inject/fs/open.c:1101'
    gdb.b(bpline)
    gdb.c()
    sh.sendline('./exp4')
    while True:
        gdb.catch()
        con=gdb.bt()
        print con
        if 'SyS_close' in con and gdb.is_current_process('exp4'):
            break
        else:
            gdb.c()

    obj_base=gdb.get_reg('rdi')
    print 'uaf_obj base:',hex(obj_base)
    callbacks_to_monitor = []
    callbacks_to_monitor.append('kfree_call_rcu')
    ce = concolicexecutor.ConcolicExecutor(vm.qemu_config.vmlinux_path)
    ce.setup(\
            qemu_port = vm.qemu_config.monitor_port\
            ,debug_after_address_concretization = False\
            ,use_custom_concretization_strategy_first = True\
            ,pause_on_read_from_symbolic_address = False\
            ,pause_on_write_to_symbolic_address = False\
            ,pause_on_uninit_write=False \
            ,pause_on_each_step = False\
            ,pause_on_write_to_uaf_object_primitive = False\
            ,execution_time_limit = 60*2\
            #,pause_on_control_flow_hijack = False\
            ,pause_on_control_flow_hijack = True\
            #,pause_on_each_step = True\
            ,concretization_range = 2\
            ,callback_functions_to_monitor = callbacks_to_monitor\
            ,expected_start_rip = 0xffffffff8119a6f0\
            ,assigned_start_time = start_time\
            ,detect_rcu_free = True\
            )
    remove_opts={angr.options.CONSERVATIVE_READ_STRATEGY}
    ce.run(uaf_object_base = obj_base, uaf_object_size = 0xf8, do_rop = True, switch_cpu = True, remove_opts = remove_opts)
    vm.shutdown()

if __name__ == '__main__':
    test_4557()

